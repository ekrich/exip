name: Main-CI

on:
  pull_request:
  push:
    branches: [main, topic/doc]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, macos-14, windows-2022]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout current branch (full)
        uses: actions/checkout@v6

      - name: Setup (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
            sudo apt-get update
            sudo apt-get install -y check doxygen

      - name: Setup (Mac)
        if: startsWith(matrix.os, 'macos')
        run: |
            brew install check doxygen

      - name: Setup (Windows)
        if: startsWith(matrix.os, 'windows-2022')
        uses: microsoft/setup-msbuild@v2

      - name: Run tests ${{matrix.os}}
        if: startsWith(matrix.os, 'windows') == false
        run: |
            cd build/gcc
            echo "Run build"
            make TARGET=pc clean all check examples utils doc
            echo "Run examples"
            cd ../..
            examples/run-examples

      - name: Run tests ${{matrix.os}}
        if: (startsWith(matrix.os, 'windows-2022'))
        run: |
            vcpkg integrate install
            echo "Running build ..."
            msbuild.exe build\vs2022\exip.sln -property:Configuration=Debug
            scripts\run-unit-tests.bat
            echo "Run examples (todo)"

      - name: Prepare Pages Content
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          mkdir staging
          # Copy your .nojekyll from root to staging
          cp .nojekyll staging/
          # Copy your new 'docs' content into staging
          cp -r docs/www/* staging/
          cp -r docs/user staging/user
          cp -r docs/dev/doxygen/html staging/doxygen

      - name: Upload Pages Artifact
        if: startsWith(matrix.os, 'ubuntu') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/topic/doc')
        uses: actions/upload-pages-artifact@v3
        with:
          path: staging/
